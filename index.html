<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cash Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  max-width: 400px;
  margin: auto;
}
.row {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
}
.row input {
  width: 60px;
  padding: 5px;
  font-size: 16px;
}
h2 { margin-top: 25px; }
button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  font-size: 18px;
}
.totalBox {
  font-size: 22px;
  margin-top: 12px;
  font-weight: bold;
}
</style>
</head>
<body>

<h2>Cash Count</h2>

<label>Date:
<input type="date" id="date">
</label>

<div id="container"></div>

<div class="totalBox">Total: <span id="total">$0.00</span></div>
<div class="totalBox">Final (minus $300 float): <span id="final">$0.00</span></div>

<button id="save">Save</button>
<button id="clear">Clear</button>
<button id="export">Export CSV</button>

<script>
const DENOMS = [
  100, 50, 20, 10, 5, 2, 1,
  0.25, 0.10, 0.05
];

const container = document.getElementById('container');

DENOMS.forEach(value => {
  const row = document.createElement('div');
  row.className = 'row';

  row.innerHTML = `
    <span>$${value.toFixed(2)}</span>
    <span>x</span>
    <input type="number" min="0" value="0">
    <span>=</span>
    <span class="lineTotal">$0.00</span>
  `;

  container.appendChild(row);
});

// calculation function
function calc() {
  let total = 0;
  const rows = container.querySelectorAll('.row');

  rows.forEach((row, i) => {
    const qty = parseFloat(row.querySelector("input").value) || 0;
    const denom = DENOMS[i];
    const line = qty * denom;
    row.querySelector(".lineTotal").textContent = `$${line.toFixed(2)}`;
    total += line;
  });

  document.getElementById('total').textContent = `$${total.toFixed(2)}`;
  document.getElementById('final').textContent = `$${(total - 300).toFixed(2)}`;
}

container.addEventListener("input", calc);

// local storage
const KEY = "cashcount";

function save() {
  const rows = container.querySelectorAll(".row");
  const items = [];

  rows.forEach((r, i) => {
    items.push({
      denom: DENOMS[i],
      qty: r.querySelector("input").value
    });
  });

  const record = {
    date: document.getElementById("date").value,
    items: items,
    total: document.getElementById("total").textContent,
    final: document.getElementById("final").textContent
  };

  const all = JSON.parse(localStorage.getItem(KEY) || "[]");
  all.push(record);
  localStorage.setItem(KEY, JSON.stringify(all));

  alert("Saved!");
}

function clearAll() {
  document.getElementById("date").value = "";
  const rows = container.querySelectorAll(".row");
  rows.forEach(r => r.querySelector("input").value = 0);
  calc();
}

// CSV export
function exportCSV() {
  let csv = "Denomination,Quantity,Line Total\n";

  const rows = container.querySelectorAll(".row");
  rows.forEach((row, i) => {
    const qty = row.querySelector("input").value;
    const denom = DENOMS[i];
    const line = parseFloat(qty || 0) * denom;
    csv += `${denom},${qty},${line.toFixed(2)}\n`;
  });

  csv += `Total,,${document.getElementById('total').textContent.replace('$','')}\n`;
  csv += `Final,,${document.getElementById('final').textContent.replace('$','')}\n`;

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "cashcount.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

document.getElementById("save").addEventListener("click", save);
document.getElementById("clear").addEventListener("click", clearAll);
document.getElementById("export").addEventListener("click", exportCSV);

// load last save
(function () {
  const all = JSON.parse(localStorage.getItem(KEY) || "[]");
  if (!all.length) return;

  const last = all[all.length - 1];

  document.getElementById("date").value = last.date || "";

  const rows = container.querySelectorAll(".row");
  rows.forEach((r, i) => {
    r.querySelector("input").value = last.items[i].qty;
  });

  calc();
})();

// service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
